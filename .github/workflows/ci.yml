name: CI

on:
  push:
    branches: [ main, master, Back, develop ]
  pull_request:
    branches: [ main, master, Back, develop ]

jobs:
  test:
    name: 테스트 및 린트
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    
    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4
    
    - name: Python ${{ matrix.python-version }} 설정
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: 의존성 설치
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install ruff  # 린터
    
    - name: Ruff 린트 검사
      run: |
        # Python 파일 포맷 검사 (자동 수정 없이 체크만)
        ruff check Back/Web --output-format=github
      continue-on-error: true  # 린트 오류 시에도 테스트는 계속 진행
    
    - name: pytest 단위 테스트 실행
      working-directory: Back/Web
      env:
        # 테스트용 환경변수
        JWT_SECRET_KEY: test-secret-key-for-ci-only
        KAKAO_REST_API_KEY: test-kakao-key
        KAKAO_REDIRECT_URI: http://localhost:8000/test
        ALGORITHM: HS256
        ACCESS_TOKEN_EXPIRE_MINUTES: 60
      run: |
        pytest tests/ -v --tb=short --cov=. --cov-report=term-missing
    
    - name: 테스트 커버리지 리포트 업로드
      if: matrix.python-version == '3.12'
      uses: codecov/codecov-action@v4
      with:
        files: ./Back/Web/.coverage
        fail_ci_if_error: false
        verbose: true
      continue-on-error: true  # Codecov 실패 시에도 CI는 성공으로 처리

  security-check:
    name: 보안 취약점 검사
    runs-on: ubuntu-latest
    
    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4
    
    - name: Python 설정
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"
    
    - name: Safety로 의존성 취약점 검사
      run: |
        pip install safety
        safety check --file=requirements.txt --continue-on-error
      continue-on-error: true  # 취약점 발견 시에도 워크플로우는 계속
